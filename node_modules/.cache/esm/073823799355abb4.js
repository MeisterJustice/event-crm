let User,Event,Blog,TicketPurchase,Email,Donor,passport,requestt,request,_,util,deleteProfileImage,crypto,sgMail;_935‍.x([["getIndex",()=>getIndex],["privacy",()=>privacy],["postForm",()=>postForm],["donate",()=>donate],["getCallback",()=>getCallback],["emailSignup",()=>emailSignup],["getFacebookLogin",()=>getFacebookLogin],["postFacebookLogin",()=>postFacebookLogin],["getRegister",()=>getRegister],["postRegister",()=>postRegister],["getLogin",()=>getLogin],["postLogin",()=>postLogin],["getLogout",()=>getLogout],["getProfile",()=>getProfile],["updateProfile",()=>updateProfile],["getTicketShow",()=>getTicketShow],["forgotPassword",()=>forgotPassword],["putForgotPassword",()=>putForgotPassword],["resetPassword",()=>resetPassword],["putResetPassword",()=>putResetPassword]]);_935‍.w("../models/user",[["default",["User"],function(v){User=v}]]);_935‍.w("../models/event",[["default",["Event"],function(v){Event=v}]]);_935‍.w("../models/blog",[["default",["Blog"],function(v){Blog=v}]]);_935‍.w("../models/ticketPurchase",[["default",["TicketPurchase"],function(v){TicketPurchase=v}]]);_935‍.w("../models/email-signup",[["default",["Email"],function(v){Email=v}]]);_935‍.w("../models/donate",[["default",["Donor"],function(v){Donor=v}]]);_935‍.w("passport",[["default",["passport"],function(v){passport=v}]]);_935‍.w("superagent",[["default",["requestt"],function(v){requestt=v}]]);_935‍.w("request",[["default",["request"],function(v){request=v}]]);_935‍.w("lodash",[["default",["_"],function(v){_=v}]]);_935‍.w("util",[["default",["util"],function(v){util=v}]]);_935‍.w("../middleware",[["deleteProfileImage",["deleteProfileImage"],function(v){deleteProfileImage=v}]]);_935‍.w("crypto",[["default",["crypto"],function(v){crypto=v}]]);_935‍.w("@sendgrid/mail",[["default",["sgMail"],function(v){sgMail=v}]]);require('dotenv').config()











const { cloudinary } = require('../cloudinary');



sgMail.setApiKey(process.env.SENDGRID_API_KEY);
const {initializePayment, verifyPayment} = require('../config/paystack')(request);

       const getIndex = async(req, res, next) => {
  let blog = await Blog.find({});
  let event = await Event.find({});
  res.render('index', {blog, event});
}

       const privacy = async(req, res, next) => {
  res.render('privacy');
}

       const postForm = async (req, res, next) => {
  const msg = {
    to: 'thechiefje@gmail.com',
    from: req.body.email,
    subject: 'Event crm - Contact form',
    text: `${req.body.name} ${req.body.phone} ${req.body.message}`,
    html: `<p>${req.body.message}</p> <br> <p>${req.body.name} <br><p>${req.body.phone}</p></p>`
  };

  await sgMail.send(msg);
  req.flash("success", `Message sent successfully`);
  res.redirect('/');
}

       const donate = (req, res, next) => {
  const form = _.pick(req.body,['amount','email','full_name']);
    form.metadata = {
        full_name : form.full_name
    }
    form.amount *= 100;
    initializePayment(form, (error, body)=>{
        if(error){
            //handle errors
            _935‍.g.console.log(error);
            return;
       }
       const response = JSON.parse(body);
       _935‍.g.console.log(response);
       res.redirect(response.data.authorization_url)
    });
}

       const getCallback = async(req, res, next) => {
  const ref = await req.query.reference;
    await verifyPayment(ref, (error,body)=>{
        if(error){
            //handle errors appropriately
            _935‍.g.console.log(error)
            return res.redirect('/error');
        }
        const response = JSON.parse(body);
        _935‍.g.console.log(response);
        const data = [response.data.reference, response.data.amount / 100, response.data.customer.email, response.data.metadata.full_name]
       
        const [reference, amount, email, full_name] = data;
        const newDonor = {reference, amount, email, full_name}
        const donor = new Donor(newDonor)
        donor.save();
        res.redirect('/admin');
        
    })
}

       const emailSignup = async (req, res, next) => {
  // save to database
  let userEmail = await Email.create(req.body);
  console.log(`${req.body.email} just signed up`);

  // save to mailchimp
  let mailchimpInstance = await process.env.MAILCHIMP_INSTANCE,
    listUniqueId = await process.env.MAILCHIMP_ID,
    mailchimpApiKey = await process.env.MAILCHIMP_API_KEY;

  await requestt
    .post('https://' + mailchimpInstance + '.api.mailchimp.com/3.0/lists/' + listUniqueId + '/members/')
    .set('Content-Type', 'application/json;charset=utf-8')
    .set('Authorization', 'Basic ' + new Buffer('any:' + mailchimpApiKey).toString('base64'))
    .send({
      'email_address': req.body.email,
      'status': 'subscribed',
      'merge_fields': {
        'FNAME': req.body.firstName,
        'LNAME': req.body.lastName
      }
    })
    .end(function (err, response) {
      if (response.status < 300 || (response.status === 400 && response.body.title === "Member Exists")) {
        console.log('mailchimp worked')
        res.redirect('back');
      } else {
        res.redirect('back');
      }
    });
}

       const getFacebookLogin = passport.authenticate('facebook', {
  scope: ['email']
});

       const postFacebookLogin = passport.authenticate('facebook', {
  successRedirect: '/',
  failureRedirect: '/login',
  session: false
})

       const getRegister = async (req, res, next) => {
  res.render("auth/register");
}

       const postRegister = async (req, res, next) => {
  try {
		if (req.file) {
			const { secure_url, public_id } = req.file;
			req.body.image = {
				secure_url,
				public_id
			}
    }
    let newUser = await new User({
      firstName : req.body.firstName,
      lastName : req.body.lastName,
      sex : req.body.sex,
      email : req.body.email,
      username : req.body.username
      });
		const user = await User.register(newUser, req.body.password);
		req.login(user, function(err) {
			if (err) {
        req.flash('error', `${err}`);
        return res.redirect('/login');
      }
			req.flash('success', `Welcome, ${user.username}!`);
			res.redirect('/');
		});
	} catch(err) {
		deleteProfileImage(req);
		const { username, email } = req.body;
		let error = err.message;
		if (error.includes('duplicate') && error.includes('index: email_1 dup key')) {
			error = 'A user with the given email is already registered';
		}
		res.render('auth/register', { title: 'Register', username, email, error });
	}
}

       const getLogin = async (req, res, next) => {
  res.render("auth/login");
}

       const postLogin = async (req, res, next) => {
  const {
    username,
    password
  } = req.body;
  const {
    user,
    error
  } = await User.authenticate()(username, password);
  if (!user && error) {
    req.flash('error', "Wrong username or password!");
    return res.redirect('/login');
  }
  req.login(user, function (err) {
    if (err) return res.redirect('/login');
    req.flash('success', `Welcome back ${username}`);
    const redirectUrl = req.session.redirectTo || '/';
    delete req.session.redirectTo;
    res.redirect(redirectUrl);
  });
}

       const getLogout = async (req, res, next) => {
  req.logout();
  req.flash("success", "Logged you out!");
  res.redirect("/");
}

       const getProfile = async (req, res, next) => {
  let user = await User.findById(req.params.id);
  let event = await Event.find().where('author.id').equals(user._id).exec();
  let total = 0;
  for(var i = event.length -1; i >= 0; i--) {
    total += event[i].totalEventAmount;
  }
  user.totalAmount = total;
  await user.save();
  res.render('profile/index', {user, event});
}

       const updateProfile = async (req, res, next) => {
  const {
		username,
    email,
    firstName,
    lastName,
    about,
    state,
    city
	} = req.body;
	const user = await User.findById(req.params.id);
	if (username) user.username = username;
  if (email) user.email = email;
  if (firstName) user.firstName = firstName;
  if (lastName) user.lastName = lastName;
  if (state) user.state = state;
  if (city) user.city = city;
	if (req.file) {
		if (user.image.public_id) await cloudinary.v2.uploader.destroy(user.image.public_id);
		const { secure_url, public_id } = req.file;
		user.image = { secure_url, public_id };
	}
	await user.save();
	const login = util.promisify(req.login.bind(req));
	await login(user);
	req.flash('success', 'Profile successfully updated!');
	res.redirect(`back`);
}


       const getTicketShow = async (req, res, next) => {
  let user = await User.findById(req.params.id);
  let event = await Event.findById(req.params.ticket_id);
  let ticket = await TicketPurchase.find().where('eventId.id').equals(event._id).exec();
  _935‍.g.console.log(ticket);
  res.render('profile/ticket_show', {ticket, event});
}


       const forgotPassword = async (req, res, next) => {
  res.render('auth/forgot');
}

       const putForgotPassword = async (req, res, next) => {
  const token = await crypto.randomBytes(20).toString('hex');

  const user = await User.findOne({
    email: req.body.email
  })
  if (!user) {
    req.flash('error', 'No account with that email address exists.');
    return res.redirect('/forgot-password');
  }

  user.resetPasswordToken = token;
  user.resetPasswordExpires = Date.now() + 3600000; // 1 hour

  await user.save();


  const msg = {
    to: user.email,
    from: 'Event Admin < thechiefje@gmail.com >',
    subject: 'Event CRM - Forgot Password / Reset',
    text: `You are receiving this because you (or someone else) have requested the reset of the password for your account.
			Please click on the following link, or copy and paste it into your browser to complete the process:
			http://${req.headers.host}/reset-password/${token}
			If you did not request this, please ignore this email and your password will remain unchanged.`.replace(/			/g, ''),
  };

  await sgMail.send(msg);

  req.flash('success', `An e-mail has been sent to ${user.email} with further instructions.`);
  res.redirect('/forgot-password');
}

       const resetPassword = async (req, res, next) => {
  const {
    token
  } = req.params;
  const user = await User.findOne({
    resetPasswordToken: token,
    resetPasswordExpires: {
      $gt: Date.now()
    }
  });
  if (!user) {
    req.flash("error", `Password reset token is invalid or has expired!`);
    return res.redirect('/forgot-password');
  }
  res.render('auth/reset', {
    token
  });
}

       const putResetPassword = async (req, res, next) => {
  const {
    token
  } = req.params;
  const user = await User.findOne({
    resetPasswordToken: token,
    resetPasswordExpires: {
      $gt: Date.now()
    }
  });
  if (!user) {
    req.flash("error", `Password reset token is invalid or has expired!`);
    return res.redirect('/forgot-password');
  }
  if (req.body.password === req.body.confirm) {
    await user.setPassword(req.body.password);
    user.resetPasswordToken = null;
    user.resetPasswordExpires = null;
    await user.save();
    const login = util.promisify(req.login.bind(req));
    await login(user);
  } else {
    req.flash("error", `Passwords do not match!`);
    return res.redirect(`/reset-password/${token}`);
  }

  const msg = {
    to: user.email,
    from: 'Event admin <theChiefJe@gmail.com>',
    subject: 'Event crm - Password Changed',
    text: `Hello,
    This email is to confirm that the password for your account has just been changed.
    If you did not make this change, please hit reply and notify us at once.`.replace(/    /g, '')
  };

  await sgMail.send(msg);
  req.flash("success", `Password successfully updated!`);
  res.redirect('/');
}