let Event,Blog,cloudinary,cloudinaryAuth;_4ac‍.x([["getEvent",()=>getEvent],["getCreateEvent",()=>getCreateEvent],["postEvent",()=>postEvent],["showEvent",()=>showEvent],["getEdit",()=>getEdit],["putEvent",()=>putEvent],["deleteEvent",()=>deleteEvent]]);_4ac‍.w("../models/event",[["default",["Event"],function(v){Event=v}]]);_4ac‍.w("../models/blog",[["default",["Blog"],function(v){Blog=v}]]);_4ac‍.w("cloudinary",[["default",["cloudinary"],function(v){cloudinary=v}]]);_4ac‍.w("../config/auth",[["default",["cloudinaryAuth"],function(v){cloudinaryAuth=v}]]);




// cloudinary configuration
cloudinary.config({
    cloud_name: cloudinaryAuth.cloudinaryUpload.cloud_name,
    api_key: cloudinaryAuth.cloudinaryUpload.api_key,
    api_secret: cloudinaryAuth.cloudinaryUpload.api_secret
})

       const getEvent = async(req, res, next) => {
    let findEvent = await Event.find({});
    res.render("event/index", {findEvent});
  }

         const getCreateEvent = async(req, res, next) => {
    res.render("event/new")
}

       const postEvent = async(req, res, next) => {
    let author = await {
        id: req.user._id,
        username: req.user.username
    }

    req.body.author = author;
    
    req.body.images = [];
    let images = await req.body.images;
    for(const file of req.files) {
        let image = await cloudinary.v2.uploader.upload(file.path);
        images.push({
            url: image.secure_url,
            public_id: image.public_id
        });
    }    

    await Event.create(req.body);
    res.redirect("/event");
}

       const showEvent = async(req, res, next) => {
    let latestBlog = await Blog.find({});
    let event = await Event.findById(req.params.id).populate('comments').exec();
    res.render("event/show", {event, latestBlog})
}

       const getEdit = async(req, res, next) => {
    let showEdit = await Event.findById(req.params.id);
    res.render("event/edit", {showEdit})
}

       const putEvent = async(req, res, next) => {
    let event = await Event.findById(req.params.id);
		if(req.body.deleteImages && req.body.deleteImages.length) {			
			let deleteImages = req.body.deleteImages;
			for(const public_id of deleteImages) {
				await cloudinary.v2.uploader.destroy(public_id);
				for(const image of event.images) {
					if(image.public_id === public_id) {
						let index = event.images.indexOf(image);
						event.images.splice(index, 1);
					}
				}
			}
		}
		if(req.files) {
			for(const file of req.files) {
				let image = await cloudinary.v2.uploader.upload(file.path);
				event.images.push({
					url: image.secure_url,
					public_id: image.public_id
				});
			}
		}
    event.title = req.body.title;
    event.description = req.body.description;
    event.city = req.body.city;
    event.venue = req.body.venue;
    event.lat = req.body.lat;
    event.lng = req.body.lng;
    event.mainImage = req.body.mainImage;
    event.save();
    res.redirect(`/event/${event.id}`);
}

       const deleteEvent = async(req, res, next) => {
    let event = await Event.findById(req.params.id);
    await Event.findByIdAndRemove();
    res.redirect("/event");
}