let User,Email,passport,nodemailer,request;_267‍.x([["getIndex",()=>getIndex],["postForm",()=>postForm],["emailSignup",()=>emailSignup],["getFacebookLogin",()=>getFacebookLogin],["postFacebookLogin",()=>postFacebookLogin],["getRegister",()=>getRegister],["postRegister",()=>postRegister],["getLogin",()=>getLogin],["postLogin",()=>postLogin],["getLogout",()=>getLogout]]);_267‍.w("../models/user",[["default",["User"],function(v){User=v}]]);_267‍.w("../models/email-signup",[["default",["Email"],function(v){Email=v}]]);_267‍.w("passport",[["default",["passport"],function(v){passport=v}]]);_267‍.w("nodemailer",[["default",["nodemailer"],function(v){nodemailer=v}]]);_267‍.w("superagent",[["default",["request"],function(v){request=v}]]);require('dotenv').config()






       const getIndex = (req, res, next) => {
  res.render('index');
}

       const postForm = async (req, res, next) => {
  let output = await `
    from:  ${req.body.name}
    email: ${req.body.email}
    phone number: ${req.body.phone}


${req.body.message}
  `;

  let mailOpts, smtpTrans;
  smtpTrans = await nodemailer.createTransport({
    service: 'gmail',

    auth: {
      type: 'OAuth2',
      user: 'thechiefje@gmail.com',
      clientId: '557',
      clientSecret: '5557',
      refreshToken: '5777'

    }
  });

  mailOpts = await {
    from: `Nodemailer contact <${req.body.email}`,
    to: 'thechiefje@gmail.com',
    subject: 'New message from contact form at event crm',
    text: output
  };
  await smtpTrans.sendMail(mailOpts, (error, response) => {
    if (error) {
      _267‍.g.console.log(error);
      res.redirect('/');
    } else {
      _267‍.g.console.log(response);
      res.redirect('/');
    }
  });
}

       const emailSignup = async (req, res, next) => {
  // save to database
  let userEmail = await Email.create(req.body);
  console.log(`${req.body.email} just signed up`);

  // save to mailchimp
  let mailchimpInstance = await process.env.MAILCHIMP_INSTANCE,
    listUniqueId = await process.env.MAILCHIMP_ID,
    mailchimpApiKey = await process.env.MAILCHIMP_API_KEY;

    await request
      .post('https://' + mailchimpInstance + '.api.mailchimp.com/3.0/lists/' + listUniqueId + '/members/')
      .set('Content-Type', 'application/json;charset=utf-8')
      .set('Authorization', 'Basic ' + new Buffer('any:' + mailchimpApiKey).toString('base64'))
      .send({
        'email_address': req.body.email,
        'status': 'subscribed',
        'merge_fields': {
          'FNAME': req.body.firstName,
          'LNAME': req.body.lastName
        }
      })
      .end(function (err, response) {
        if (response.status < 300 || (response.status === 400 && response.body.title === "Member Exists")) {
          console.log('mailchimp worked')
          res.redirect('/');
        } else {
          res.redirect('/')
        }
  });
}

       const getFacebookLogin = passport.authenticate('facebook', {
  scope: ['email']
});

       const postFacebookLogin = passport.authenticate('facebook', {
  successRedirect: '/',
  failureRedirect: '/login',
  session: false
})

       const getRegister = async (req, res, next) => {
  res.render("auth/register");
}

       const postRegister = async (req, res, next) => {
  let newUser = await new User({
    username: req.body.username,
    firstName: req.body.firstName,
    lastName: req.body.lastName,
    sex: req.body.sex,
    email: req.body.email
  });
  await User.register(newUser, req.body.password);
  // req.flash("success", "welcome");
  console.log(`${newUser.username} just registered!`)
  res.redirect("/event");
}

       const getLogin = async (req, res, next) => {
  res.render("auth/login");
}

       const postLogin = async (req, res, next) => passport.authenticate("local", {
  successRedirect: "/event",
  failureRedirect: "/login"
})(req, res, next)

       const getLogout = async (req, res, next) => {
  req.logout();
  // req.flash("success", "Logged you out!");
  res.redirect("/");
}