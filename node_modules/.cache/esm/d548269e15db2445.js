let passport,FacebookStrategy,User,configAuth;_15d‍.w("passport",[["default",["passport"],function(v){passport=v}]]);_15d‍.w("passport-facebook",[["default",["FacebookStrategy"],function(v){FacebookStrategy=v}]]);_15d‍.w("../models/user",[["default",["User"],function(v){User=v}]]);_15d‍.w("./auth",[["default",["configAuth"],function(v){configAuth=v}]]);





module.exports = function(passport){
    passport.use(new FacebookStrategy({
        clientID: configAuth.facebookAuth.clientID,
        clientSecret: configAuth.facebookAuth.clientSecret,
        callbackURL: configAuth.facebookAuth.callbackURL,
        profileFields: configAuth.facebookAuth.profileFields,
    enableProof: true, 
    passReqToCallback: true 
    },
    function (accessToken, refreshToken, profile, done) {
        process.nextTick(function () {
            User.findOne({
                'facebook.id': profile.id
            }, function (err, user) {
                if (err)
                    return done(err);
                if (user)
                    return done(null, user);
                else {
                    let newUser = new User();
                    newUser.facebook.id = profile.id,
                        newUser.facebook.token = accessToken,
                        newUser.facebook.name = profile.name.givenName + " " + profile.name.familyName,
                        newUser.facebook.email = profile.email;

                    newUser.save(function (err) {
                        if (err)
                            throw err;
                        return done(null, newUser);
                    })
                }
            });
        });
    }

));
}